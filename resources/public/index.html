<!DOCTYPE html>
<html>
    <head>
        <title>&#9733; Two-a-day</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <link href="css/main.css" media="screen" rel="stylesheet" type="text/css" />
        <link href="css/mobile.css" media="screen and (max-width:640px)" rel="stylesheet" type="text/css" />
        <link href="http://fonts.googleapis.com/css?family=Roboto+Slab:100,400" rel="stylesheet" type="text/css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    </head>
    <body>
        <div id="banner">
            <h1>What was the best thing about your day?</h1>
        </div>
        <div id="days">
            <div id="last-week">
                <div id="today" class="day">
                    <span class="content" contenteditable></span>
                </div>
            </div>
            <div id="previous"></div>
        </div>
    </body>
    <script type="text/javascript">
        $('#days #today .content[contenteditable')
            .on('keydown', function(e) {
                switch (e.which) {
                    case 32: // space
                        var number_of_spaces = ($(this).text().match(/ /g) || []).length;
                        if (number_of_spaces) {
                            e.preventDefault();
                        }
                        break;
                    case 13: // return
                        $(this).blur();
                        e.preventDefault();
                        break;
                }
            })
            .on('blur', function() {
                var content = $(this).text();
                var date = $(this).closest('.day').data('date');
                $.post('/api/today', {content: content}, function(msg) {
                    console.log(msg);
                });
            });

        $('#days')
            .on('click', '.day:not(#today)', function() {
                // TODO: make today favouritable?
                var day = $(this).closest('.day');

                console.log(day.data('date'))

                day.toggleClass('fav');

                $.post('/api/day/' + day.data('date'), {fav: day.hasClass('fav')}, function(msg) {
                    console.log(msg);
                });
            });

        function createDayEl(day) {
            if (day.today) {
                return $('#today')
                    [day.fav ? 'addClass' : 'removeClass']('fav')
                    .removeClass('Mon Tue Wed Thu Fri Sat Sun')
                    .addClass(day.day)
                    .find('.content')
                        .text(day.content)
                    .end();
            } else {
                return $('<div class="day">')
                    .data('date', day.date)
                    .addClass(day.day)
                    .addClass(day.fav ? 'fav' : null)
                    .append(
                        $('<span class="content">')
                            .text(day.content)
                    );
            }
        }

        $.get('/api/last-week', function(days) {
            $('#last-week').append( $.map(days, createDayEl) );

            var today = $('#today .content[contenteditable]');
            if (today.text().length == 0) {
                today.focus();
                window.scrollTo(0, 0);
            }

            var last_day = days[days.length-1];
            if (last_day) {
                $.get('/api/faves?before=' + last_day.date, function(days) {
                    $('#previous').append( $.map(days, createDayEl) );
                });
            }

            // TODO: fetch more when scrolled to the bottom
        });

    </script>
</html>
